---
import Input from '@/components/ui/form/Input/Input.astro';
import Textarea from '@/components/ui/form/Textarea/Textarea.astro';
import Button from '@/components/ui/form/Button/Button.astro';
import { cn } from '@/lib/cn';

interface Props {
  action?: string;
  successMessage?: string;
  class?: string;
}

const {
  action = '/api/contact',
  successMessage = 'Message sent successfully!',
  class: className,
} = Astro.props;
---

<form
  id="contact-form"
  action={action}
  method="POST"
  class={cn('space-y-6', className)}
  data-success-message={successMessage}
>
  <Input
    label="Name"
    name="name"
    type="text"
    required
    autocomplete="name"
  />

  <Input
    label="Email"
    name="email"
    type="email"
    required
    autocomplete="email"
  />

  <Input
    label="Subject"
    name="subject"
    type="text"
  />

  <Textarea
    label="Message"
    name="message"
    required
    rows={5}
  />

  <!-- Honeypot field for spam protection -->
  <div class="hidden" aria-hidden="true">
    <input type="text" name="honeypot" tabindex="-1" autocomplete="off" />
  </div>

  <div id="form-message" class="hidden text-sm"></div>

  <Button type="submit" fullWidth id="submit-button">
    Submit
  </Button>
</form>

<script>
  function initContactForm() {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const button = document.getElementById('submit-button') as HTMLButtonElement;
    const message = document.getElementById('form-message') as HTMLDivElement;

    if (!form || !button || !message) return;

    const successMessage = form.dataset.successMessage || 'Message sent successfully!';

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      button.disabled = true;
      button.textContent = 'Sending...';
      message.classList.add('hidden');

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          message.textContent = successMessage;
          message.className = 'text-sm text-success';
          form.reset();
        } else {
          const errors = data.errors
            ? Object.values(data.errors).flat().join(', ')
            : 'Something went wrong';
          message.textContent = errors as string;
          message.className = 'text-sm text-destructive';
        }
      } catch {
        message.textContent = 'Failed to send message. Please try again.';
        message.className = 'text-sm text-destructive';
      } finally {
        button.disabled = false;
        button.textContent = 'Submit';
        message.classList.remove('hidden');
      }
    });
  }

  initContactForm();
  document.addEventListener('astro:after-swap', initContactForm);
</script>
