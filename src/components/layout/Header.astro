---
/**
 * Header Component (i18n-aware)
 * Flexible navigation header with variant-based configuration and language switching
 *
 * Variants:
 * - layout: 'default' | 'centered' | 'minimal'
 * - position: 'fixed' | 'sticky' | 'static'
 * - size: 'sm' | 'md' | 'lg'
 * - variant: 'default' | 'solid' | 'transparent'
 * - colorScheme: 'default' | 'invert' (use 'invert' for dark backgrounds)
 * - shape: 'bar' | 'floating' (use 'floating' for capsule header)
 *
 * Features:
 * - Dynamic navigation with translations
 * - Language switcher integration
 * - Optional CTA button
 * - Mobile menu with Escape key support
 * - Theme toggle
 * - Full slot support for customization
 * - Floating capsule shape with scroll-reactive bg + color flip
 */
import type { HTMLAttributes } from 'astro/types';
import { cn } from '@/lib/cn';
import { headerVariants, headerInnerVariants } from './header.variants';
import Button from '@/components/ui/form/Button/Button.astro';
import Icon from '@/components/ui/primitives/Icon/Icon.astro';
import Logo from '@/components/ui/marketing/Logo/Logo.astro';
import ThemeToggle from '@/components/layout/ThemeToggle.astro';
import LanguageSwitcher from '@/components/i18n/LanguageSwitcher.astro';
import siteConfig from '@/config/site.config';
import { type Locale, defaultLocale, getLocaleFromPath } from '@/i18n/config';
import { useTranslations, getLocalizedPath, getNavRoutes } from '@/i18n/index';

export interface NavItem {
  label: string;
  href: string;
}

export interface HeaderAction {
  icon: string;
  href: string;
  label: string;
  iconOnly?: boolean;
  target?: string;
}

interface Props extends HTMLAttributes<'header'> {
  /** Locale for translations */
  locale?: Locale;
  /** Layout style: default (logo left, nav right), centered (logo center), minimal (logo + cta only) */
  layout?: 'default' | 'centered' | 'minimal';
  /** Position behavior */
  position?: 'fixed' | 'sticky' | 'static';
  /** Header height */
  size?: 'sm' | 'md' | 'lg';
  /** Background variant */
  variant?: 'default' | 'solid' | 'transparent';
  /** Color scheme for text/icons - use 'invert' for dark backgrounds */
  colorScheme?: 'default' | 'invert';
  /** Shape: 'bar' (full-width, default) or 'floating' (centered capsule) */
  shape?: 'bar' | 'floating';
  /** Override default navigation */
  nav?: NavItem[];
  /** Additional navigation items (e.g., #features for landing pages) */
  extraNav?: NavItem[];
  /** Show CTA button */
  showCta?: boolean;
  /** CTA button configuration */
  cta?: { label?: string; href?: string };
  /** Action buttons (GitHub, etc.) */
  actions?: HeaderAction[];
  /** Show theme toggle (default: true) */
  showThemeToggle?: boolean;
  /** Show language switcher (default: true) */
  showLanguageSwitcher?: boolean;
  /** Show mobile menu (default: true) */
  showMobileMenu?: boolean;
  /** Show active state for current page (default: true) */
  showActiveState?: boolean;
  /** Logo text override */
  logoText?: string;
  /** Hide logo entirely */
  hideLogo?: boolean;
}

const {
  locale: localeProp,
  layout = 'default',
  position = 'sticky',
  size = 'md',
  variant = 'default',
  colorScheme = 'default',
  shape = 'bar',
  nav,
  extraNav = [],
  showCta = false,
  cta = { label: 'Get Started', href: '#cta' },
  actions = [],
  showThemeToggle = true,
  showLanguageSwitcher = true,
  showMobileMenu = true,
  showActiveState = true,
  logoText,
  hideLogo = false,
  class: className,
  ...attrs
} = Astro.props;

// Get locale from prop or infer from URL
const locale = localeProp || getLocaleFromPath(Astro.url.pathname);
const t = useTranslations(locale);

// Shape + color scheme helpers
const isFloating = shape === 'floating';
const isInvert = colorScheme === 'invert';

// Get navigation items from i18n routes or custom nav
const defaultNav = getNavRoutes(locale);
const navItems: NavItem[] = nav || [...extraNav, ...defaultNav.map(route => ({
  label: t(route.label as any) || route.label,
  href: route.path,
}))];

// Current path for active state
const currentPath = Astro.url.pathname;

// Check if we're on the landing page
const isLandingPage = currentPath === '/' || currentPath === `/${locale}` || currentPath === `/${locale}/`;

// Process CTA href for landing page anchor links
const ctaHref = cta.href?.startsWith('#') && !isLandingPage
  ? `/${cta.href}`
  : cta.href;

// Check slots
const hasLogoSlot = Astro.slots.has('logo');
const hasNavSlot = Astro.slots.has('nav');
const hasActionsSlot = Astro.slots.has('actions');
const hasMobileMenuSlot = Astro.slots.has('mobile-menu');

// Compute header classes using CVA
const headerClasses = cn(
  headerVariants({ position, variant, shape }),
  isInvert && !isFloating && 'invert-section',
  className
);

// Compute inner container classes
const innerClasses = headerInnerVariants({ size, shape });

// Check if a nav item is active
function isActive(href: string): boolean {
  if (!showActiveState) return false;
  if (href.startsWith('#')) return false;
  return currentPath === href || currentPath.startsWith(href + '/');
}

// Generate unique ID for this header instance
const menuId = `mobile-menu-${Math.random().toString(36).slice(2, 9)}`;
const buttonId = `${menuId}-button`;
---

<header
  class={headerClasses}
  data-header-shape={shape}
  data-header-variant={variant}
  data-header-color-scheme={colorScheme}
  {...attrs}
>
  <div class={innerClasses}>
    {/* Logo */}
    {!hideLogo && (
      hasLogoSlot ? (
        <slot name="logo" />
      ) : (
        <a href={getLocalizedPath('home', locale)} class="flex items-center gap-2">
          {isFloating && isInvert ? (
            <>
              <Logo size={size === 'lg' ? 'md' : 'sm'} forceDark={true} class="hdr-logo-inverted" />
              <Logo size={size === 'lg' ? 'md' : 'sm'} forceDark={false} class="hdr-logo-normal" />
            </>
          ) : (
            <Logo size={size === 'lg' ? 'md' : 'sm'} forceDark={isInvert} />
          )}
          <span class={cn(
            'font-display text-xl font-bold tracking-tight',
            isFloating ? 'hdr-logo-text' : (isInvert ? 'text-on-invert' : 'text-brand-500')
          )}>
            {logoText || siteConfig.name}
          </span>
        </a>
      )
    )}

    {/* Desktop Navigation */}
    {layout !== 'minimal' && (
      hasNavSlot ? (
        <nav class="hidden items-center gap-1 md:flex" aria-label="Main navigation">
          <slot name="nav" />
        </nav>
      ) : (
        <nav class="hidden items-center gap-1 md:flex" aria-label="Main navigation">
          {navItems.map(({ label, href }) => (
            <a
              href={href.startsWith('#') && !isLandingPage ? `/${href}` : href}
              class={cn(
                'nav-link relative rounded-md px-3 py-2 text-sm',
                'transition-all duration-(--transition-fast)',
                isFloating && 'hdr-invert-text',
                isFloating
                  ? (isActive(href)
                      ? 'hdr-nav-active font-semibold'
                      : 'font-medium opacity-80 hover:opacity-100')
                  : (isActive(href)
                      ? cn('nav-link-active font-semibold', isInvert ? 'text-on-invert bg-white/10' : 'text-foreground bg-secondary')
                      : cn('nav-link-inactive font-medium', isInvert ? 'text-on-invert-secondary hover:text-on-invert hover:bg-white/10' : 'text-foreground-muted hover:text-foreground hover:bg-secondary/70'))
              )}
              aria-current={isActive(href) ? 'page' : undefined}
            >
              {label}
            </a>
          ))}
        </nav>
      )
    )}

    {/* Actions Area */}
    <div class="flex items-center gap-2">
      {hasActionsSlot ? (
        <slot name="actions" />
      ) : (
        <>
          {showLanguageSwitcher && <LanguageSwitcher />}
          {showThemeToggle && (
            <ThemeToggle class={isFloating ? 'hdr-invert-text' : undefined} />
          )}

          {actions.map((action) => (
            <Button
              variant="ghost"
              size="sm"
              icon={action.iconOnly}
              href={action.href}
              target={action.target}
              aria-label={action.label}
              class={isFloating ? 'hdr-invert-text' : undefined}
            >
              <Icon name={action.icon} size="sm" />
              {!action.iconOnly && action.label}
            </Button>
          ))}

          {showCta && (
            <Button
              size="sm"
              href={ctaHref}
              class={isFloating ? 'hdr-invert-cta rounded-full' : undefined}
            >
              {cta.label}
            </Button>
          )}
        </>
      )}

      {/* Mobile Menu Toggle */}
      {showMobileMenu && layout !== 'minimal' && (
        <button
          type="button"
          id={buttonId}
          class={cn(
            'md:hidden inline-flex items-center justify-center rounded-md p-2',
            'transition-colors',
            'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring',
            isFloating
              ? 'hdr-invert-text'
              : (isInvert
                  ? 'text-on-invert-secondary hover:text-on-invert hover:bg-white/10'
                  : 'text-foreground-muted hover:text-foreground hover:bg-secondary')
          )}
          aria-expanded="false"
          aria-controls={menuId}
          aria-label="Toggle menu"
        >
          <span class="menu-icon">
            <Icon name="menu" size="md" />
          </span>
          <span class="close-icon hidden">
            <Icon name="x" size="md" />
          </span>
        </button>
      )}
    </div>
  </div>

  {/* Mobile Menu */}
  {showMobileMenu && layout !== 'minimal' && (
    hasMobileMenuSlot ? (
      <div
        id={menuId}
        class={cn(
          'md:hidden hidden opacity-0 origin-top scale-y-0 shadow-[0_8px_24px_-12px_rgba(0,0,0,0.12)]',
          isFloating
            ? 'rounded-b-2xl bg-background/95 backdrop-blur-xl'
            : 'border-t border-border bg-background'
        )}
        role="navigation"
        aria-label="Mobile navigation"
      >
        <slot name="mobile-menu" />
      </div>
    ) : (
      <div
        id={menuId}
        class={cn(
          'md:hidden hidden opacity-0 origin-top scale-y-0 shadow-[0_8px_24px_-12px_rgba(0,0,0,0.12)]',
          isFloating
            ? 'rounded-b-2xl bg-background/95 backdrop-blur-xl'
            : 'border-t border-border bg-background'
        )}
        role="navigation"
        aria-label="Mobile navigation"
      >
        <div class={cn(
          'space-y-1 py-4',
          isFloating ? 'px-6' : 'mx-auto max-w-6xl px-6'
        )}>
          {navItems.map(({ label, href }) => (
            <a
              href={href.startsWith('#') && !isLandingPage ? `/${href}` : href}
              class={cn(
                'mobile-nav-link block px-3 py-2 rounded-md text-sm',
                'transition-all duration-(--transition-fast)',
                isActive(href)
                  ? 'mobile-nav-link-active font-semibold bg-secondary text-foreground'
                  : 'mobile-nav-link-inactive font-medium text-foreground-muted hover:bg-secondary/70 hover:text-foreground'
              )}
              aria-current={isActive(href) ? 'page' : undefined}
            >
              {label}
            </a>
          ))}

          {showCta && (
            <div class="mt-3 pt-3 border-t border-border">
              <Button fullWidth href={ctaHref}>
                {cta.label}
              </Button>
            </div>
          )}
        </div>
      </div>
    )
  )}
</header>

{/* Mobile Menu Backdrop - positioned outside header to blur page content */}
{showMobileMenu && layout !== 'minimal' && (
  <div
    id={`${menuId}-backdrop`}
    class="md:hidden fixed inset-0 opacity-0 pointer-events-none transition-opacity duration-200 z-40"
    aria-hidden="true"
  />
)}

<script define:vars={{ menuId, buttonId, shape }}>
  function initMobileMenu() {
    const button = document.getElementById(buttonId);
    const menu = document.getElementById(menuId);
    const backdrop = document.getElementById(`${menuId}-backdrop`);
    const header = button?.closest('header');
    const menuIcon = button?.querySelector('.menu-icon');
    const closeIcon = button?.querySelector('.close-icon');
    const isFloating = shape === 'floating';

    if (!button || !menu || !menuIcon || !closeIcon) return;

    let isOpen = false;
    let isAnimating = false;

    function open() {
      if (isOpen || isAnimating) return;
      isAnimating = true;
      isOpen = true;

      button.setAttribute('aria-expanded', 'true');
      menuIcon.classList.add('hidden');
      closeIcon.classList.remove('hidden');

      if (isFloating && header) {
        // Force scrolled state + flatten bottom corners
        header.setAttribute('data-scrolled', '');
        header.classList.remove('rounded-2xl');
        header.classList.add('rounded-t-2xl');
      } else if (header) {
        header.classList.add('!bg-background');
      }

      // Fade out and blur the page content
      const mainContent = document.querySelector('main');
      const footer = document.querySelector('footer');
      if (mainContent) {
        mainContent.style.transition = 'opacity 200ms, filter 200ms';
        mainContent.style.opacity = '0.3';
        mainContent.style.filter = 'blur(4px)';
      }
      if (footer) {
        footer.style.transition = 'opacity 200ms, filter 200ms';
        footer.style.opacity = '0.3';
        footer.style.filter = 'blur(4px)';
      }

      // Show menu and backdrop with animations
      menu.classList.remove('hidden', 'animate-menu-up', 'opacity-0', 'scale-y-0');
      menu.classList.add('animate-menu-down');
      if (backdrop) {
        backdrop.classList.remove('pointer-events-none', 'animate-backdrop-out');
        backdrop.classList.add('animate-backdrop');
      }

      isAnimating = false;
    }

    function close() {
      if (!isOpen || isAnimating) return;
      isAnimating = true;

      button.setAttribute('aria-expanded', 'false');
      menuIcon.classList.remove('hidden');
      closeIcon.classList.add('hidden');

      // Start closing animation
      menu.classList.remove('animate-menu-down');
      menu.classList.add('animate-menu-up');
      if (backdrop) {
        backdrop.classList.remove('animate-backdrop');
        backdrop.classList.add('animate-backdrop-out');
      }

      // Restore page content
      const mainContent = document.querySelector('main');
      const footer = document.querySelector('footer');
      if (mainContent) {
        mainContent.style.opacity = '1';
        mainContent.style.filter = 'none';
      }
      if (footer) {
        footer.style.opacity = '1';
        footer.style.filter = 'none';
      }

      // Wait for animation to complete before hiding
      setTimeout(() => {
        menu.classList.add('hidden', 'opacity-0', 'scale-y-0');
        if (backdrop) {
          backdrop.classList.add('pointer-events-none');
        }

        if (isFloating && header) {
          header.classList.remove('rounded-t-2xl');
          header.classList.add('rounded-2xl');
          if (window.scrollY <= 60) {
            header.removeAttribute('data-scrolled');
          }
        } else if (header) {
          header.classList.remove('!bg-background');
        }

        isOpen = false;
        isAnimating = false;
      }, 200);
    }

    function toggle() {
      if (isOpen) {
        close();
      } else {
        open();
      }
    }

    button.addEventListener('click', toggle);

    // Close on backdrop click
    if (backdrop) {
      backdrop.addEventListener('click', close);
    }

    // Close on Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && isOpen) {
        close();
      }
    });

    // Close when clicking on mobile menu links
    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', close);
    });
  }

  initMobileMenu();
  document.addEventListener('astro:page-load', initMobileMenu);
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>

<script>
  const SCROLL_THRESHOLD = 60;

  function initScrollWatcher() {
    document.querySelectorAll('header[data-header-shape="floating"]').forEach((header) => {
      if (header.dataset.scrollInit) return;
      header.dataset.scrollInit = 'true';

      let ticking = false;

      function onScroll() {
        if (ticking) return;
        ticking = true;

        requestAnimationFrame(() => {
          if (window.scrollY > SCROLL_THRESHOLD) {
            header.setAttribute('data-scrolled', '');
          } else {
            // Don't remove if mobile menu is open
            const menu = header.querySelector('[role="navigation"]');
            const menuOpen = menu && !menu.classList.contains('hidden');
            if (!menuOpen) {
              header.removeAttribute('data-scrolled');
            }
          }
          ticking = false;
        });
      }

      window.addEventListener('scroll', onScroll, { passive: true });

      // Set initial state
      onScroll();
    });
  }

  initScrollWatcher();
  document.addEventListener('astro:page-load', initScrollWatcher);
  document.addEventListener('astro:after-swap', initScrollWatcher);
</script>

<style is:global>
  /* ===== Floating header: frosted glass (all modes) ===== */
  [data-header-shape="floating"] {
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    backdrop-filter: blur(20px) saturate(180%);
  }

  /* ===== Light mode: glass tint on light background ===== */
  [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) {
    background: color-mix(in oklch, var(--color-background) 70%, transparent) !important;
    border-color: var(--color-border) !important;
  }

  /* ===== Dark mode: glass tint on dark background ===== */
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) {
    background: rgba(255, 255, 255, 0.08) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
  }

  /* ===== Scrolled state (both modes): solid frosted glass ===== */
  [data-header-shape="floating"][data-scrolled] {
    background: color-mix(in oklch, var(--color-background) 85%, transparent) !important;
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    backdrop-filter: blur(24px) saturate(180%);
    border-color: var(--color-border) !important;
    box-shadow:
      0 4px 20px -6px rgba(0, 0, 0, 0.08),
      0 0 0 1px color-mix(in oklch, var(--color-border) 40%, transparent);
  }

  /* ===== LIGHT MODE: normal design-system colors (hero bg is light) ===== */

  /* Logo: show normal responsive variant */
  [data-header-shape="floating"][data-header-color-scheme="invert"] .hdr-logo-inverted {
    display: none;
  }
  [data-header-shape="floating"][data-header-color-scheme="invert"] .hdr-logo-normal {
    display: inline-block;
  }

  /* Text: normal foreground */
  [data-header-shape="floating"][data-header-color-scheme="invert"] .hdr-invert-text {
    color: var(--color-foreground-muted) !important;
    transition: color 300ms;
  }
  [data-header-shape="floating"][data-header-color-scheme="invert"] .hdr-invert-text:hover {
    color: var(--color-foreground) !important;
  }

  /* Logo text: brand */
  [data-header-shape="floating"][data-header-color-scheme="invert"] .hdr-logo-text {
    color: var(--color-brand-500) !important;
    transition: color 300ms;
  }

  /* CTA: normal primary */
  [data-header-shape="floating"][data-header-color-scheme="invert"] .hdr-invert-cta {
    background: var(--color-primary) !important;
    color: var(--color-primary-foreground) !important;
    border-color: transparent !important;
    transition: background 300ms, color 300ms, border-color 300ms;
  }

  /* ===== DARK MODE at top: inverted colors (hero bg is dark) ===== */

  /* Logo: show dark-bg variant, hide normal */
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-logo-inverted {
    display: inline-block;
  }
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-logo-normal {
    display: none;
  }

  /* Text: white for dark hero */
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-invert-text {
    color: var(--color-on-invert) !important;
  }
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-invert-text:hover {
    color: var(--color-on-invert) !important;
  }

  /* Logo text: white for dark hero */
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-logo-text {
    color: var(--color-on-invert) !important;
  }

  /* CTA: white pill on dark hero */
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-invert-cta {
    background: white !important;
    color: #111 !important;
    border-color: transparent !important;
  }
  .dark [data-header-shape="floating"][data-header-color-scheme="invert"]:not([data-scrolled]) .hdr-invert-cta:hover {
    background: rgba(255, 255, 255, 0.9) !important;
  }

  /* ===== SCROLLED STATE (both modes): normal design-system colors ===== */

  /* Logo: always show normal responsive variant */
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-logo-inverted {
    display: none !important;
  }
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-logo-normal {
    display: inline-block !important;
  }

  /* Text: foreground */
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-invert-text,
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-invert-text:hover {
    color: var(--color-foreground) !important;
  }

  /* Logo text: brand */
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-logo-text {
    color: var(--color-brand-500) !important;
  }

  /* CTA: primary */
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-invert-cta {
    background: var(--color-primary) !important;
    color: var(--color-primary-foreground) !important;
    border-color: transparent !important;
  }
  [data-header-shape="floating"][data-header-color-scheme="invert"][data-scrolled] .hdr-invert-cta:hover {
    opacity: 0.9;
  }

  /* ===== Non-invert floating (shape only, no color flip) ===== */
  [data-header-shape="floating"][data-header-color-scheme="default"] .hdr-logo-text {
    color: var(--color-brand-500);
  }
  [data-header-shape="floating"][data-header-color-scheme="default"] .hdr-invert-text {
    color: var(--color-foreground-muted);
    transition: color 300ms;
  }
  [data-header-shape="floating"][data-header-color-scheme="default"] .hdr-invert-text:hover {
    color: var(--color-foreground);
  }

  /* ===== Floating nav link underline indicators ===== */
  [data-header-shape="floating"] .nav-link::after {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    right: 50%;
    height: 2px;
    background: currentColor;
    border-radius: 1px;
    transition: left 200ms, right 200ms;
  }

  [data-header-shape="floating"] .nav-link:hover::after,
  [data-header-shape="floating"] .nav-link.hdr-nav-active::after {
    left: 12px;
    right: 12px;
  }

  /* ===== Reduced motion ===== */
  @media (prefers-reduced-motion: reduce) {
    [data-header-shape="floating"],
    [data-header-shape="floating"] .hdr-invert-text,
    [data-header-shape="floating"] .hdr-logo-text,
    [data-header-shape="floating"] .hdr-invert-cta,
    [data-header-shape="floating"] .nav-link::after {
      transition: none !important;
    }
  }
</style>
