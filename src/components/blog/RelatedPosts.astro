---
import BlogCard from './BlogCard.astro';
import { getCollection } from 'astro:content';
import { defaultLocale, type Locale } from '@/i18n/config';
import { useTranslations } from '@/i18n/index';

interface Props {
  currentSlug: string;
  tags: string[];
  locale?: Locale;
  maxPosts?: number;
}

const { currentSlug, tags, locale = defaultLocale, maxPosts = 3 } = Astro.props;
const t = useTranslations(locale);

// Get all published posts in the same locale
const allPosts = await getCollection('blog', ({ data }) => {
  return data.locale === locale && (import.meta.env.PROD ? data.draft !== true : true);
});

// Filter to find posts with matching tags
const relatedPosts = allPosts
  .filter((post) => {
    // Exclude current post
    if (post.id === currentSlug || post.id.endsWith(`/${currentSlug}`)) return false;

    // Must have at least one matching tag
    if (!tags.length) return false;
    return post.data.tags.some((tag) => tags.includes(tag));
  })
  // Sort by number of matching tags, then by date
  .sort((a, b) => {
    const aMatches = a.data.tags.filter((tag) => tags.includes(tag)).length;
    const bMatches = b.data.tags.filter((tag) => tags.includes(tag)).length;

    if (bMatches !== aMatches) return bMatches - aMatches;
    return b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf();
  })
  .slice(0, maxPosts);

// Generate URLs for each post (locale-aware)
const getPostUrl = (postId: string) => {
  const slug = postId.replace(`${locale}/`, '');
  // Default locale doesn't have prefix
  if (locale === defaultLocale) {
    return `/blog/${slug}`;
  }
  return `/${locale}/blog/${slug}`;
};
---

{relatedPosts.length > 0 && (
  <section class="border-t border-border pt-12 mt-12">
    <h2 class="font-display text-2xl font-bold text-foreground mb-8">
      {t('blog.relatedPosts')}
    </h2>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {relatedPosts.map((post) => (
        <BlogCard
          title={post.data.title}
          description={post.data.description}
          href={getPostUrl(post.id)}
          publishedAt={post.data.publishedAt}
          tags={post.data.tags}
          author={post.data.author}
          image={post.data.image}
        />
      ))}
    </div>
  </section>
)}
